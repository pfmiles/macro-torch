# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

macro-torch is a World of Warcraft addon for Turtle WoW (private server) that generates SuperMacro addon code. It provides a macro creation helper with object-oriented Lua classes and combat event tracking.

## Build and Development Commands

### Build the addon

```bash
./build.sh
```

The build script concatenates all Lua files in a specific order into `SM_Extend.lua` and copies it to the SuperMacro addon directory.

**File Concatenation Order:**
1. `macro_torch.lua` - Global namespace initialization
2. `impl_util.lua` - Utility functions
3. `interface_debug.lua` - Debug interface functions
4. `Unit.lua` - Base Unit class
5. All other `*.lua` files (except the output file)

**Note:** Do not manually edit `SM_Extend.lua` - it is generated by the build script and ignored by git.

## Code Architecture

### Object-Oriented Design

The codebase uses Lua metatables to implement class inheritance. Key classes:

- **macroTorch.Unit** - Base class for all units (defined in `Unit.lua`)
  - Handles buff/debuff detection, tracking, and management
  - Provides methods for checking unit state

- **macroTorch.Player** - Player-specific functionality (extends Unit)
  - Defined in `Player.lua`
  - Spell casting, item usage, trinket management, form/stance checks

- **macroTorch.Target** - Target-specific functionality (extends Unit)
  - Defined in `Target.lua`
  - Immunity tracking, damage prediction, special target handling

- **Class-Specific Classes** - Inherit from Player
  - `macroTorch.Druid`, `macroTorch.Hunter`, etc. (in `SM_Extend_{Class}.lua`)
  - Class-specific rotation logic and abilities

### Global Objects

Three core global objects are available in all contexts:
- `macroTorch.player` - Current player instance
- `macroTorch.target` - Current target
- `macroTorch.pet` - Player's pet

### Metatable Structure

Classes use custom `__index` metamethods that search in this order:
1. Instance-specific field maps (e.g., `DRUID_FIELD_FUNC_MAP`)
2. Class methods/fields
3. Parent class methods/fields

### Combat State Management

The `battle_event_queue.lua` file implements:
- Event-driven combat tracking using WoW API events
- Spell trace registration and immune tracking
- Context management (stored in `macroTorch.context`)
- Dodge/parry/resist detection

## File Organization

- **Core Classes**: `Unit.lua`, `Player.lua`, `Target.lua`, `Pet.lua`
- **Class Logic**: `SM_Extend_{Class}.lua` (Druid, Hunter, Mage, etc.)
- **Utilities**: `impl_util.lua` (string/table utilities), `interface_debug.lua` (debugging)
- **Combat System**: `battle_event_queue.lua` (event handling, immunity tracking)
- **Supporting**: `TargetTarget.lua`, `TargetPet.lua`, `Group.lua`, `Raid.lua`

## Key Patterns

### Creating New Class Methods

```lua
-- In a class file (e.g., SM_Extend_Druid.lua)
function obj.methodName(params)
    -- Access global objects: macroTorch.player, macroTorch.target
    -- Use utility functions from impl_util.lua
    -- Check combat state via macroTorch.context
end
```

### Adding Field Function Maps

```lua
-- For class-specific dynamic fields, add to the appropriate map
macroTorch.DRUID_FIELD_FUNC_MAP["fieldName"] = function(target)
    -- Return computed value
end
```

### Working with Combat Context

```lua
-- Context is automatically managed during combat
if macroTorch.context then
    -- Store temporary state
    macroTorch.context.customField = value
end
```

## Important Notes

- The codebase is designed for WoW 1.12.1 (Vanilla/Turtle WoW) API
- Requires SuperMacro addon to function
- Combat events and timing are critical - maintain the existing timing constants
- Buff/debuff detection relies on texture strings, not names
- Always test changes in-game as Lua errors break WoW macros
